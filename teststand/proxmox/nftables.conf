#!/usr/sbin/nft -f

flush ruleset

table inet filter {
        chain input {
                type filter hook input priority 0; policy drop;

                ct state invalid counter drop comment "early drop of invalid packets"

                ct state {established, related} accept comment "accept all connections established, related"

                iif lo accept comment "accept loopback"

                ip saddr 0.0.0.0/0 tcp dport 22 accept comment "accept ssh"
                ip saddr 0.0.0.0/0 tcp dport 8006 accept comment "accept proxmox"
                ip saddr 0.0.0.0/0 tcp dport 6443 accept comment "accept kubernetes"
                ip saddr 0.0.0.0/0 tcp dport 5000 accept comment "accept talos"

                ip saddr 10.0.0.0/8 accept comment "accept from private networks"
                ip saddr 192.168.0.0/16 accept comment "accept from private networks"

                include "/tmp/nftables-*.conf"

                ip protocol icmp accept comment "accept all ICMP types"

                #log prefix "Dropped: " flags all drop comment "dropped packets logger"
                #log prefix "Rejected: " flags all reject comment "rejected packets logger"

                counter comment "count dropped packets"
        }
        chain forward {
                type filter hook forward priority 0; policy accept;
        }
        chain output {
                type filter hook output priority 0; policy accept;
        }
}

table ip nat {
        chain postrouting {
                type nat hook postrouting priority srcnat; policy accept;
                oifname "enp41s0" ip saddr 10.0.0.0/8 masquerade comment "masquerade lan"
                oifname "enp41s0" ip saddr 192.168.0.0/16 masquerade comment "masquerade lan"
        }
}
